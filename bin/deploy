#!/usr/bin/env bash

set -euo pipefail

# Run this script to deploy the app to Github Pages

# Default options
SRC_BRANCH="master"
DEPLOY_BRANCH="gh-pages"
NO_PUSH=""
CONFIRMATION_REQUIRED="true"

USAGE_MSG="usage: deploy [-h|--help] [-u|--user] [-s|--src SRC_BRANCH] [-d|--deploy DEPLOY_BRANCH] [--verbose] [--no-push] [-y|--yes|--force]"

while [[ $# -gt 0 ]]; do
    key="$1"

    case $key in
        -h|--help)
            echo "$USAGE_MSG"
            exit 0
            ;;
        -u|--user)
            SRC_BRANCH="source"
            DEPLOY_BRANCH="master"
            ;;
        -s|--src)
            SRC_BRANCH="$2"
            shift
            ;;
        -d|--deploy)
            DEPLOY_BRANCH="$2"
            shift
            ;;
        --verbose)
            set -x
            ;;
        --no-push)
            NO_PUSH="--no-push"
            ;;
        -y|--yes|--force)
            CONFIRMATION_REQUIRED="false"
            ;;
        *)
            echo "Option $1 is unknown." >&2
            echo "$USAGE_MSG" >&2
            exit 1
            ;;
    esac
    shift
done

echo "Deploying..."
echo "Source branch: $SRC_BRANCH"
echo "Deploy branch: $DEPLOY_BRANCH"

if [[ "$CONFIRMATION_REQUIRED" == "true" ]]; then
    read -r -p "Do you want to proceed? [y/N] " response || true
    if [[ ! ${response:-} =~ ^([yY][eE][sS]|[yY])$ ]]; then
        echo "Aborting."
        exit 1
    fi
fi

# Check if there are any uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "Changes to the following files are uncommitted:"
    git diff-index --name-only HEAD --
    echo "Please commit the changes before proceeding."
    echo "Aborting."
    exit 1
fi

# Check if there are any untracked files
if [[ -n "$(git ls-files --exclude-standard --others)" ]]; then
    echo "There are untracked files:"
    git ls-files --exclude-standard --others
    echo "Please commit those files or stash them before proceeding."
    echo "Aborting."
    exit 1
fi

# Switch to source branch (creates it if necessary from the current branch)
if git rev-parse --verify --quiet "refs/heads/${SRC_BRANCH}" >/dev/null; then
    git checkout "$SRC_BRANCH"
else
    git checkout -b "$SRC_BRANCH"
fi

cleanup() {
    git checkout "$SRC_BRANCH" >/dev/null 2>&1 || true
}
trap cleanup EXIT

# Checkout DEPLOY_BRANCH branch
if git rev-parse --verify --quiet "refs/heads/${DEPLOY_BRANCH}" >/dev/null; then
    git branch -D "$DEPLOY_BRANCH"
fi

git checkout -b "$DEPLOY_BRANCH"

# Build site
bundle exec jekyll build

if [[ ! -d _site ]]; then
    echo "Jekyll build did not produce the _site directory."
    exit 1
fi

# Delete and move files
shopt -s dotglob nullglob
for entry in *; do
    case "$entry" in
        _site|.git|CNAME|.gitignore)
            continue
            ;;
    esac
    rm -rf "$entry"
done
mv _site/* .
shopt -u dotglob nullglob
rm -rf _site/

# Push to DEPLOY_BRANCH
git add -fA
git commit --allow-empty -m "$(git log -1 --pretty=%B) [ci skip]"
if [[ -z "$NO_PUSH" ]]; then
    git push -f -q origin "$DEPLOY_BRANCH"
fi

# Move back to SRC_BRANCH
git checkout "$SRC_BRANCH"
trap - EXIT

echo "Deployed successfully!"

exit 0
